import React from 'react';
import { ResponsiveContainer, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, Tooltip } from 'recharts';
import { Card } from '../../../components/ui/card';
import '../josoor.css';

interface DualLensHUDProps {
  data: any[];        // Internal Efficiency Metrics
  outcomes: any[];    // External Impact Metrics
  initiatives: any[]; // Investment Portfolios
}

export const DualLensHUD: React.FC<DualLensHUDProps> = ({ data = [], outcomes = [], initiatives = [] }) => {
  
  // CRITICAL FIX: Array Validation
  const safeInternalData = Array.isArray(data) ? data : [];
  const safeOutcomesData = Array.isArray(outcomes) ? outcomes : [];

  const processChartData = () => {
    return safeInternalData.slice(0, 6).map((item, index) => ({
      subject: item.label || item.metric || `Metric ${index + 1}`,
      internal: item.value || item.score || 0,
      external: safeOutcomesData[index]?.value || safeOutcomesData[index]?.score || 0,
      fullMark: 100,
    }));
  };

  const chartData = processChartData();

  return (
    <div className="grid grid-cols-12 gap-4 h-full">
      {/* LEFT LENS: Internal Efficiency */}
      <div className="col-span-12 md:col-span-4 flex flex-col">
        <Card className="v2-panel h-full flex flex-col p-4 bg-black/40 border-l-2 border-[#D4AF37]">
          <h3 className="text-[#D4AF37] font-bold mb-2 uppercase text-sm tracking-wider">
            Internal Efficiency
          </h3>
          <div className="flex-1 min-h-[200px]">
            {safeInternalData.length > 0 ? (
               <ResponsiveContainer width="100%" height="100%">
                 <RadarChart cx="50%" cy="50%" outerRadius="80%" data={chartData}>
                   <PolarGrid stroke="#4B5563" />
                   {/* @ts-ignore */}
                   <PolarAngleAxis dataKey="subject" tick={{ fill: '#9CA3AF', fontSize: 10 }} />
                   <PolarRadiusAxis angle={30} domain={[0, 100]} tick={false} axisLine={false} />
                   <Radar
                     name="Internal"
                     dataKey="internal"
                     stroke="#D4AF37"
                     strokeWidth={2}
                     fill="#D4AF37"
                     fillOpacity={0.3}
                   />
                   <Tooltip 
                     contentStyle={{ backgroundColor: '#1F2937', borderColor: '#D4AF37', color: '#F3F4F6' }}
                     itemStyle={{ color: '#D4AF37' }}
                   />
                 </RadarChart>
               </ResponsiveContainer>
            ) : (
              <div className="flex items-center justify-center h-full text-gray-500 text-xs">
                No Internal Data
              </div>
            )}
          </div>
        </Card>
      </div>

      {/* CENTER: Synthesis / Health Score */}
      <div className="col-span-12 md:col-span-4 flex flex-col justify-center items-center">
         <div className="text-center space-y-4">
            <div className="text-4xl font-black text-white drop-shadow-[0_0_10px_rgba(212,175,55,0.5)]">
               V1.3
            </div>
            <div className="text-xs text-gray-400 tracking-widest uppercase">
               Dual Lens Architecture
            </div>
            {/* Health Pulse Indicator */}
            <div className="relative w-24 h-24 mx-auto flex items-center justify-center rounded-full border-2 border-[#D4AF37] bg-black/50">
               <span className="text-2xl font-bold text-[#D4AF37]">94%</span>
               <div className="absolute inset-0 rounded-full border border-[#D4AF37] animate-ping opacity-20"></div>
            </div>
         </div>
      </div>

      {/* RIGHT LENS: External Impact */}
      <div className="col-span-12 md:col-span-4 flex flex-col">
        <Card className="v2-panel h-full flex flex-col p-4 bg-black/40 border-r-2 border-[#00FFFF]">
          <h3 className="text-[#00FFFF] font-bold mb-2 uppercase text-sm tracking-wider text-right">
            External Impact
          </h3>
          <div className="flex-1 min-h-[200px]">
             {safeOutcomesData.length > 0 ? (
               <ResponsiveContainer width="100%" height="100%">
                 <RadarChart cx="50%" cy="50%" outerRadius="80%" data={chartData}>
                   <PolarGrid stroke="#4B5563" />
                   {/* @ts-ignore */}
                   <PolarAngleAxis dataKey="subject" tick={{ fill: '#9CA3AF', fontSize: 10 }} />
                   <PolarRadiusAxis angle={30} domain={[0, 100]} tick={false} axisLine={false} />
                   <Radar
                     name="External"
                     dataKey="external"
                     stroke="#00FFFF"
                     strokeWidth={2}
                     fill="#00FFFF"
                     fillOpacity={0.3}
                   />
                   <Tooltip 
                     contentStyle={{ backgroundColor: '#1F2937', borderColor: '#00FFFF', color: '#F3F4F6' }}
                     itemStyle={{ color: '#00FFFF' }}
                   />
                 </RadarChart>
               </ResponsiveContainer>
             ) : (
               <div className="flex items-center justify-center h-full text-gray-500 text-xs">
                 No Outcomes Data
               </div>
             )}
          </div>
        </Card>
      </div>
    </div>
  );
};
