#!/usr/bin/env bash
# dashboard-create: Create a dashboard from JSON file
#
# Usage: dashboard-create <deployment> <json-file>
#
# The JSON file should NOT contain id, version, createdAt, updatedAt fields.
# Use templates or dashboard-from-template to generate valid JSON.
#
# Examples:
#   dashboard-create prod ./my-dashboard.json
#   dashboard-create staging ./dashboard.json

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

DEPLOYMENT="${1:-}"
JSON_FILE="${2:-}"

if [[ -z "$DEPLOYMENT" || -z "$JSON_FILE" ]]; then
    echo "Usage: dashboard-create <deployment> <json-file>" >&2
    exit 1
fi

if [[ ! -f "$JSON_FILE" ]]; then
    echo "Error: File not found: $JSON_FILE" >&2
    exit 1
fi

# Read and strip server-managed fields
BODY=$(jq 'del(.id, .version, .createdAt, .updatedAt, .createdBy, .updatedBy)' "$JSON_FILE")

# Validate required fields
for field in name owner; do
    if [[ $(echo "$BODY" | jq -r ".$field // empty") == "" ]]; then
        echo "Error: Missing required field: $field" >&2
        exit 1
    fi
done

RESPONSE=$("$SCRIPT_DIR/axiom-api" "$DEPLOYMENT" POST "/internal/dashboards" "$BODY")

# Extract and print the new dashboard ID
ID=$(echo "$RESPONSE" | jq -r '.id // empty')
if [[ -n "$ID" ]]; then
    echo "$ID"
else
    echo "Error creating dashboard:" >&2
    echo "$RESPONSE" | jq . >&2
    exit 1
fi
