#!/usr/bin/env bash
# axiom-api: Make authenticated requests to Axiom API
#
# Usage: axiom-api <deployment> <method> <path> [json-body]
#
# Reads credentials from ~/.axiom.toml (shared with axiom-sre)
#
# Examples:
#   axiom-api prod GET /internal/dashboards
#   axiom-api prod GET /internal/dashboards/abc123
#   axiom-api prod POST /internal/dashboards '{"name":"Test",...}'
#   axiom-api prod GET /v2/user

set -euo pipefail

DEPLOYMENT="${1:-}"
METHOD="${2:-}"
PATH_="${3:-}"
BODY="${4:-}"

if [[ -z "$DEPLOYMENT" || -z "$METHOD" || -z "$PATH_" ]]; then
    echo "Usage: axiom-api <deployment> <method> <path> [json-body]" >&2
    exit 1
fi

CONFIG_FILE="$HOME/.axiom.toml"
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Error: $CONFIG_FILE not found" >&2
    exit 1
fi

# Parse TOML for deployment config
extract_value() {
    local key="$1"
    awk -v deployment="$DEPLOYMENT" -v key="$key" '
        /^\[deployments\./ { in_deployment = ($0 ~ "\\[deployments\\." deployment "\\]") }
        in_deployment && $1 == key { gsub(/[" ]/, "", $3); print $3; exit }
    ' "$CONFIG_FILE"
}

URL=$(extract_value "url")
TOKEN=$(extract_value "token")
ORG_ID=$(extract_value "org_id")

if [[ -z "$URL" || -z "$TOKEN" || -z "$ORG_ID" ]]; then
    echo "Error: Could not find deployment '$DEPLOYMENT' in $CONFIG_FILE" >&2
    exit 1
fi

# Dashboard API uses app.* instead of api.*
API_URL="${URL/api./app.}/api"

CURL_ARGS=(
    -s
    -X "$METHOD"
    -H "Authorization: Bearer $TOKEN"
    -H "X-Axiom-Org-Id: $ORG_ID"
    -H "Content-Type: application/json"
    -H "Accept: application/json"
)

if [[ -n "$BODY" ]]; then
    CURL_ARGS+=(-d "$BODY")
fi

curl "${CURL_ARGS[@]}" "${API_URL}${PATH_}"
