#!/usr/bin/env bash
# dashboard-link: Generate a link to an Axiom dashboard
#
# Usage: dashboard-link <deployment> <dashboard-id>
#
# Examples:
#   dashboard-link prod EHYTHcQmO0ZZCK0zdw
#   dashboard-link staging abc123

set -euo pipefail

DEPLOYMENT="${1:-}"
DASHBOARD_ID="${2:-}"

if [[ -z "$DEPLOYMENT" || -z "$DASHBOARD_ID" ]]; then
    echo "Usage: dashboard-link <deployment> <dashboard-id>" >&2
    exit 1
fi

CONFIG_FILE="$HOME/.axiom.toml"
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Error: $CONFIG_FILE not found" >&2
    exit 1
fi

# Parse TOML for deployment config
extract_value() {
    local key="$1"
    awk -v deployment="$DEPLOYMENT" -v key="$key" '
        /^\[deployments\./ { in_deployment = ($0 ~ "\\[deployments\\." deployment "\\]") }
        in_deployment && $1 == key { gsub(/[" ]/, "", $3); print $3; exit }
    ' "$CONFIG_FILE"
}

URL=$(extract_value "url")
ORG_ID=$(extract_value "org_id")

if [[ -z "$URL" || -z "$ORG_ID" ]]; then
    echo "Error: Could not find deployment '$DEPLOYMENT' in $CONFIG_FILE" >&2
    exit 1
fi

# Convert API URL to app URL
# api.axiom.co -> app.axiom.co
# api.dev.axiomtestlabs.co -> app.dev.axiomtestlabs.co
APP_URL="${URL/api./app.}"

echo "${APP_URL}/${ORG_ID}/dashboards/${DASHBOARD_ID}"
