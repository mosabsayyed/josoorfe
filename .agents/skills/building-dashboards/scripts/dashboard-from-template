#!/usr/bin/env bash
# dashboard-from-template: Instantiate a dashboard template with substitutions
#
# Usage: dashboard-from-template <template> <service> <owner_id> <dataset> [output-file]
#
# Arguments:
#   template    - Template name: service-overview, api-health, blank
#   service     - Service name
#   owner_id    - Axiom user ID (find yours via: scripts/get-user-id prod)
#   dataset     - Dataset name
#   output-file - Output path (default: stdout)
#
# Examples:
#   dashboard-from-template service-overview "api-gateway" "AxBcDefG1234" "http-logs"
#   dashboard-from-template api-health "payment-api" "AxBcDefG1234" "payment-logs" ./payment.json

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEMPLATE_DIR="$SCRIPT_DIR/../reference/templates"

if [[ $# -lt 4 ]]; then
    echo "Usage: dashboard-from-template <template> <service> <owner_id> <dataset> [output-file]" >&2
    echo "" >&2
    echo "Available templates:" >&2
    for f in "$TEMPLATE_DIR"/*.json; do
        basename "$f" .json >&2
    done
    exit 1
fi

TEMPLATE_NAME="$1"
SERVICE="$2"
OWNER_ID="$3"
DATASET="$4"
OUTPUT="${5:-/dev/stdout}"

TEMPLATE="$TEMPLATE_DIR/$TEMPLATE_NAME.json"

if [[ ! -f "$TEMPLATE" ]]; then
    echo "Error: Template '$TEMPLATE_NAME' not found" >&2
    echo "" >&2
    echo "Available templates:" >&2
    for f in "$TEMPLATE_DIR"/*.json; do
        basename "$f" .json >&2
    done
    exit 1
fi

# Replace placeholders
sed -e "s/{{service}}/$SERVICE/g" \
    -e "s/{{owner_id}}/$OWNER_ID/g" \
    -e "s/{{dataset}}/$DATASET/g" \
    -e "s/{{name}}/$SERVICE/g" \
    -e "s/{{description}}/Dashboard for $SERVICE/g" \
    "$TEMPLATE" > "$OUTPUT"

if [[ "$OUTPUT" != "/dev/stdout" ]]; then
    echo "Created: $OUTPUT" >&2
fi
