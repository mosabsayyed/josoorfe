#!/usr/bin/env bash
# get-user-id: Get the current user's ID from the API token
#
# Usage: get-user-id <deployment>
#
# Returns the user ID that should be used as owner_id when creating dashboards.
#
# Examples:
#   get-user-id prod
#   get-user-id staging

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

DEPLOYMENT="${1:-}"

if [[ -z "$DEPLOYMENT" ]]; then
    echo "Usage: get-user-id <deployment>" >&2
    exit 1
fi

CONFIG_FILE="$HOME/.axiom.toml"
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Error: $CONFIG_FILE not found" >&2
    exit 1
fi

# Parse TOML for deployment config
extract_value() {
    local key="$1"
    awk -v deployment="$DEPLOYMENT" -v key="$key" '
        /^\[deployments\./ { in_deployment = ($0 ~ "\\[deployments\\." deployment "\\]") }
        in_deployment && $1 == key { gsub(/[" ]/, "", $3); print $3; exit }
    ' "$CONFIG_FILE"
}

URL=$(extract_value "url")
TOKEN=$(extract_value "token")

if [[ -z "$URL" || -z "$TOKEN" ]]; then
    echo "Error: Could not find deployment '$DEPLOYMENT' in $CONFIG_FILE" >&2
    exit 1
fi

# Get user info from API
RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" "${URL}/v2/user")

USER_ID=$(echo "$RESPONSE" | jq -r '.id // empty')

if [[ -z "$USER_ID" ]]; then
    echo "Error: Could not get user ID from API" >&2
    echo "Check that your token in ~/.axiom.toml is valid" >&2
    exit 1
fi

echo "$USER_ID"
