version: '3.8'

services:
  neo4j-staging:
    image: neo4j:5.15-enterprise
    container_name: josoor-neo4j-staging
    ports:
      - "7475:7474"  # HTTP (offset from prod 7474)
      - "7688:7687"  # Bolt (offset from prod 7687)
    environment:
      NEO4J_AUTH: neo4j/stagingpassword
      NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
      NEO4J_server_memory_heap_max__size: 4G
      NEO4J_server_memory_pagecache_size: 2G
      NEO4J_db_tx__log_rotation_retention__policy: "false"
      # Enable APOC for graph algorithms
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
      NEO4J_dbms_security_procedures_unrestricted: "gds.*,apoc.*"
      NEO4J_dbms_security_procedures_allowlist: "gds.*,apoc.*"
    volumes:
      - ./neo4j-staging-data:/data
      - ./neo4j-staging-logs:/logs
      - ./neo4j-staging-import:/var/lib/neo4j/import
      - ./backups:/backups
    networks:
      - josoor-staging
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "stagingpassword", "RETURN 1"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  josoor-staging:
    driver: bridge
